ServerRoot "/usr/local/apache2"
Listen 80
ServerName imc-waf

LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule headers_module modules/mod_headers.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule rewrite_module modules/mod_rewrite.so

# ¡IMPORTANTE! El módulo de seguridad
LoadModule security2_module modules/mod_security2.so
LoadModule unique_id_module modules/mod_unique_id.so

User daemon
Group daemon

# Habilitar Rewrite Engine
RewriteEngine On

# Proxy a tu app de Node - MEJORADO
ProxyRequests Off
ProxyPreserveHost On
ProxyPass "/" "http://app:3000/" connectiontimeout=5 timeout=30
ProxyPassReverse "/" "http://app:3000/"

# Permitir todos los métodos HTTP (incluyendo POST, PUT, DELETE)
<Proxy *>
    Require all granted
</Proxy>

# Encabezados necesarios para Node.js
<IfModule mod_headers.c>
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
    RequestHeader set X-Forwarded-Proto "%{REQUEST_SCHEME}s"
    RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
</IfModule>

#  --- Configuración ModSecurity ---
<IfModule security2_module>
    Include /etc/modsecurity/modsecurity.conf
    
    # ✅ HABILITAR ANÁLISIS DE RESPUESTA (OUTBOUND FILTERING)
    SecResponseBodyAccess On
    SecResponseBodyMimeType text/plain text/html text/xml application/json
    SecResponseBodyLimit 524288
    
    # ✅ MODO BLOQUEANTE
    SecRuleEngine On
</IfModule>

ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 combined