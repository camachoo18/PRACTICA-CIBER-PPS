# ============================================================
# EXCLUSIONES PERSONALIZADAS - ModSecurity CRS
# ============================================================
# Fecha: 5 de febrero de 2026
# Ambiente: Proyecto IMC - Docker + Apache + ModSecurity
# Paranoia Level: 1
#
# NOTA IMPORTANTE:
# Este archivo se carga DESPUÉS de todas las reglas CRS
# (orden en modsecurity.conf: línea 44)
# ============================================================

# ============================================================
# SECCIÓN 1: EXCLUSIONES POR CASO DE USO LEGÍTIMO
# ============================================================

# CASO 1: Acentos españoles en nombres (POST /api/records)
# ─────────────────────────────────────────────────────────
# Justificación: Los caracteres españoles (ó, á, ú, ñ, é) pueden
# coincidir parcialmente con patrones de SQLi en la regla 942450.
# Aplicar ANTES de análisis SQLi para permitir tráfico legítimo.
#
# Ejemplo que podría dispararse (pero permitimos):
#   POST /api/records
#   {"firstName":"José María López Martínez"}
#
# Tipo: Exclusión ANTES de CRS (whitelist de parámetro específico)

<LocationMatch "^/api/records$">
  SecRuleUpdateActionById 942450 "id:custom-exc-001,phase:2,nolog,noauditlog,pass"
  # 942450 = SQL Injection - Advanced detection
  # Permitimos porque firstName/lastName ya están validados en app
</LocationMatch>

# CASO 2: Valores decimales en peso y altura
# ─────────────────────────────────────────────────────────
# Justificación: Números flotantes como 75.5 kg o 1.82 m pueden
# coincidir con patrones de ataque en regla 920440 (Protocol Attack).
# 
# Ejemplo legítimo:
#   POST /api/records
#   {"weight":75.5,"height":182.5}
#
# Tipo: Exclusión ESPECÍFICA por parámetro

<LocationMatch "^/api/records$">
  SecRuleUpdateActionById 920440 \
    "id:custom-exc-002,phase:2,nolog,noauditlog,pass,\
     msg:'Permitir números decimales en peso/altura'"
  # 920440 = Invalid URL Encoding
</LocationMatch>

# CASO 3: Bearer tokens complejos en Authorization header
# ─────────────────────────────────────────────────────────
# Justificación: JWT tokens pueden contener caracteres especiales
# que disparen regla 921110 (Anomaly Threshold Exceeded).
# Aplicar ANTES de validación de protocolo.
#
# Ejemplo:
#   Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
#
# Tipo: Exclusión en header específico

<LocationMatch "^/api/">
  SecRuleUpdateActionById 921110 \
    "id:custom-exc-003,phase:1,nolog,noauditlog,pass,\
     msg:'Permitir headers Authorization con JWT'"
  # 921110 = HTTP Request Smuggling Attack
</LocationMatch>

# ============================================================
# SECCIÓN 2: EXCLUSIONES POR PATRÓN DE APLICACIÓN
# ============================================================

# EXCLUSIÓN GLOBAL: Permitir método OPTIONS (CORS preflight)
# ─────────────────────────────────────────────────────────
# Justificación: Requests OPTIONS para CORS pueden disparar
# reglas de validación de método innecesariamente.

SecRuleUpdateActionById 911100 \
  "id:custom-exc-004,phase:1,nolog,noauditlog,pass,\
   msg:'Permitir OPTIONS para CORS'"
# 911100 = Method is not allowed by policy

# ============================================================
# SECCIÓN 3: EXCLUSIONES DOCUMENTADAS PERO INACTIVAS
# ============================================================
# Estas exclusiones se crean como referencia para futuro uso.
# Se COMENTAN porque actualmente NO HAY falsos positivos.
# Si surgen en producción, descomenta y adapta el ID.

# FUTURA EXCLUSIÓN: Si caracteres especiales en búsqueda
# SecRuleUpdateActionById 942431 \
#   "id:custom-future-001,phase:2,nolog,noauditlog,pass,\
#    msg:'Excluir SQLi en búsquedas con caracteres especiales'"
# # 942431 = SQL Injection Attack

# ============================================================
# SECCIÓN 4: REGLAS DE AUDITORÍA Y LOGGING
# ============================================================

# Log custom para reglas removidas
SecDebugLog /var/log/apache2/modsec_custom_exclusions.log
SecDebugLogLevel 3

# ============================================================
# FIN DE EXCLUSIONES PERSONALIZADAS
# ============================================================